name: CI / CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

env:
  IMAGE_NAME: shred-day
  IMAGE_TAG: ${{ github.sha }}

jobs:
#‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BUILD + TEST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_DB: shred_day_test
          POSTGRES_USER: rails
          POSTGRES_PASSWORD: password
        ports: [5432:5432]
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    #---------------------------------------------------------------
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # 1Ô∏è‚É£ build the *ci* image (build-stage ‚Üí has gcc/make/headers)
    - name: Build CI image (build stage)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./server/Dockerfile        # keep this path
        target: build                    # <- the stage that still has tool-chain
        push: false
        load: true                       # import into runner‚Äôs docker engine
        tags: ${{ env.IMAGE_NAME }}:ci   # eg. shred-day:ci

    # 2Ô∏è‚É£ build the slim *production* image (default final stage)
    - name: Build production image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./server/Dockerfile
        push: false
        load: true
        tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    # ‚îÄ‚îÄ 2Ô∏è‚É£ run RSpec in the *ci* image (=build stage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - name: RSpec
      uses: addnab/docker-run-action@v3
      with:
        image: shred-day:ci
        options: |
          --user 0
          -e RAILS_ENV
          -e DATABASE_URL
          -e RAILS_MASTER_KEY
        run: |
          cd /rails/server
          printf '%s' "$RAILS_MASTER_KEY" > config/master.key
          chmod 600 config/master.key
          bundle install --with test --quiet
          bundle exec rails db:create db:migrate
          bundle exec rspec
          bundle exec rails db:prepare db:seed
      env:
        RAILS_ENV: test
        DATABASE_URL: postgres://rails:password@postgres:5432/shred_day_test
        RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}

    # 3Ô∏è‚É£ Start Rails container for Cypress
    - name: Launch app container (detached)
      run: |
        docker run -d --name shredday-ci \
          --network host \
          -e PORT=3000 \
          -e RAILS_ENV=production \
          -e RAILS_FORCE_SSL=false \
          -e DATABASE_URL=postgres://rails:password@localhost:5432/shred_day_test \
          -e RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }} \
          ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
          bash -lc "bundle exec rails server -b 0.0.0.0 -p \$PORT"

    # üîç¬†NEW: show status/logs before we try to exec
    - name: Show shredday‚Äëci status
      run: |
        echo "== docker ps -a =="
        docker ps -a
        echo
        echo "== inspect =="
        docker inspect \
          --format='State={{.State.Status}}  ExitCode={{.State.ExitCode}}  OOMKilled={{.State.OOMKilled}}' \
          shredday-ci || true
        echo
        echo "== last 50 log lines =="
        docker logs --tail 50 shredday-ci || true


    # # Seed DB so Cypress has data to click on
    # - name: Seed database
    #   run: docker exec shredday-ci bundle exec rails db:seed RAILS_ENV=production

    - name: Wait for Rails to boot
      run: sleep 15

    #---------------------------------------------------------------
    # 4Ô∏è‚É£ Run Cypress in its own container against http://localhost:3000
    - name: Cypress
      uses: cypress-io/github-action@v6
      with:
        working-directory: client
      env:
        CYPRESS_baseUrl: http://localhost:3000
        RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}

    # Show Rails logs if anything fails
    - name: Dump Rails log on failure
      if: failure()
      run: docker logs shredday-ci || true

#‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ DEPLOY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  deploy:
    name: Deploy
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.0'

    - name: Install Kamal
      run: gem install kamal -v $(awk '/kamal \(/ { gsub(/.*\(|\).*/, "", $0); print $0 }' server/Gemfile.lock)

    - name: Setup SSH agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Prepare Kamal secrets
      run: |
        mkdir -p .kamal
        {
          echo "KAMAL_REGISTRY_PASSWORD: $KAMAL_REGISTRY_PASSWORD"
          echo "RAILS_MASTER_KEY: $RAILS_MASTER_KEY"
          echo "POSTGRES_PASSWORD: $POSTGRES_PASSWORD"
        } >> .kamal/secrets
      env:
        KAMAL_REGISTRY_PASSWORD: ${{ secrets.KAMAL_REGISTRY_PASSWORD }}
        RAILS_MASTER_KEY:       ${{ secrets.RAILS_MASTER_KEY }}
        POSTGRES_PASSWORD:      ${{ secrets.POSTGRES_PASSWORD }}

    - name: Deploy
      env:
        RAILS_MASTER_KEY:  ${{ secrets.RAILS_MASTER_KEY }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      run: kamal deploy --verbose
