name: CI / CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

env:
  IMAGE_NAME: shred-day
  IMAGE_TAG: ${{ github.sha }}

jobs:
#‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BUILD + TEST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_DB: shred_day_test
          POSTGRES_USER: rails
          POSTGRES_PASSWORD: password
        ports: [5432:5432]
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    #---------------------------------------------------------------
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # create a buildx builder that uses the container driver (supports cache export)
    - name: Set up Docker Buildx
      id: buildx                          # üëà add an id so we can reference it
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container          # default, but explicit

    #---------------------------------------------------------------
    # 1Ô∏è‚É£ Build the production image (cached)
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        builder: ${{ steps.buildx.outputs.name }}
        context: .
        file: ./server/Dockerfile             # default, but explicit
        push: false                          # don‚Äôt publish from PRs
        tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        cache-from: type=gha
        cache-to:   type=gha,mode=max

    # 2Ô∏è‚É£ Run RSpec inside the image
    - name: RSpec
      uses: addnab/docker-run-action@v3
      with:
        image: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        options: |
          --network host
          -e RAILS_ENV=test
          -e DATABASE_URL=postgres://rails:password@localhost:5432/shred_day_test
          -e RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }}
          -e BUNDLE_WITHOUT=          # <-- clear the prod-only exclusion
        run: |
          cd /rails/server
          bundle install --with test --quiet
          bundle exec rails db:prepare
          bundle exec rspec

    # 3Ô∏è‚É£ Start Rails container for Cypress
    - name: Launch app container (detached)
      run: |
        docker run -d --name shredday-ci \
          --network host \
          -e PORT=3000 \
          -e RAILS_ENV=test \
          -e DATABASE_URL=postgres://rails:password@localhost:5432/shred_day_test \
          -e RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }} \
          ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    # Seed DB so Cypress has data to click on
    - name: Seed database
      run: docker exec shredday-ci bundle exec rails db:seed

    - name: Wait for Rails to boot
      run: sleep 15

    #---------------------------------------------------------------
    # 4Ô∏è‚É£ Run Cypress in its own container against http://localhost:3000
    - name: Cypress
      uses: cypress-io/github-action@v6
      with:
        working-directory: client
      env:
        CYPRESS_baseUrl: http://localhost:3000
        RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}

    # Show Rails logs if anything fails
    - name: Dump Rails log on failure
      if: failure()
      run: docker logs shredday-ci || true

#‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ DEPLOY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  deploy:
    name: Deploy
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.0'

    - name: Install Kamal
      run: gem install kamal -v $(awk '/kamal \(/ { gsub(/.*\(|\).*/, "", $0); print $0 }' server/Gemfile.lock)

    - name: Setup SSH agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Prepare Kamal secrets
      run: |
        mkdir -p .kamal
        {
          echo "KAMAL_REGISTRY_PASSWORD: $KAMAL_REGISTRY_PASSWORD"
          echo "RAILS_MASTER_KEY: $RAILS_MASTER_KEY"
          echo "POSTGRES_PASSWORD: $POSTGRES_PASSWORD"
        } >> .kamal/secrets
      env:
        KAMAL_REGISTRY_PASSWORD: ${{ secrets.KAMAL_REGISTRY_PASSWORD }}
        RAILS_MASTER_KEY:       ${{ secrets.RAILS_MASTER_KEY }}
        POSTGRES_PASSWORD:      ${{ secrets.POSTGRES_PASSWORD }}

    - name: Deploy
      env:
        RAILS_MASTER_KEY:  ${{ secrets.RAILS_MASTER_KEY }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      run: kamal deploy --verbose
