name: CI / CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

env:
  IMAGE_NAME: shred-day
  IMAGE_TAG: ${{ github.sha }}

jobs:
#────────────────────── BUILD + TEST ────────────────────────────
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_DB: shred_day_test
          POSTGRES_USER: rails
          POSTGRES_PASSWORD: password
        ports: [5432:5432]
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    #---------------------------------------------------------------
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # 1️⃣ build the *ci* image (build-stage → has gcc/make/headers)
    - name: Build CI image (build stage)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./server/Dockerfile        # keep this path
        target: build                    # <- the stage that still has tool-chain
        push: false
        load: true                       # import into runner’s docker engine
        tags: ${{ env.IMAGE_NAME }}:ci   # eg. shred-day:ci

    # 2️⃣ build the slim *production* image (default final stage)
    - name: Build production image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./server/Dockerfile
        push: false
        load: true
        tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    # ── 2️⃣ run RSpec in the *ci* image (=build stage) ───────────────
    - name: RSpec
      uses: addnab/docker-run-action@v3
      with:
        image: shred-day:ci              # ← tool-chain available here
        options: --user 0
        run: |
          cd /rails/server
          bundle exec rails db:prepare
          bundle exec rspec
      env:
        RAILS_ENV: test
        DATABASE_URL: postgres://rails:password@localhost:5432/shred_day_test
        RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}

    # 3️⃣ Start Rails container for Cypress
    - name: Launch app container (detached)
      run: |
        docker run -d --name shredday-ci \
          --network host \
          -e PORT=3000 \
          -e RAILS_ENV=test \
          -e DATABASE_URL=postgres://rails:password@localhost:5432/shred_day_test \
          -e RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }} \
          ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    # Seed DB so Cypress has data to click on
    - name: Seed database
      run: docker exec shredday-ci bundle exec rails db:seed

    - name: Wait for Rails to boot
      run: sleep 15

    #---------------------------------------------------------------
    # 4️⃣ Run Cypress in its own container against http://localhost:3000
    - name: Cypress
      uses: cypress-io/github-action@v6
      with:
        working-directory: client
      env:
        CYPRESS_baseUrl: http://localhost:3000
        RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}

    # Show Rails logs if anything fails
    - name: Dump Rails log on failure
      if: failure()
      run: docker logs shredday-ci || true

#──────────────────────── DEPLOY ────────────────────────────────
  deploy:
    name: Deploy
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.0'

    - name: Install Kamal
      run: gem install kamal -v $(awk '/kamal \(/ { gsub(/.*\(|\).*/, "", $0); print $0 }' server/Gemfile.lock)

    - name: Setup SSH agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Prepare Kamal secrets
      run: |
        mkdir -p .kamal
        {
          echo "KAMAL_REGISTRY_PASSWORD: $KAMAL_REGISTRY_PASSWORD"
          echo "RAILS_MASTER_KEY: $RAILS_MASTER_KEY"
          echo "POSTGRES_PASSWORD: $POSTGRES_PASSWORD"
        } >> .kamal/secrets
      env:
        KAMAL_REGISTRY_PASSWORD: ${{ secrets.KAMAL_REGISTRY_PASSWORD }}
        RAILS_MASTER_KEY:       ${{ secrets.RAILS_MASTER_KEY }}
        POSTGRES_PASSWORD:      ${{ secrets.POSTGRES_PASSWORD }}

    - name: Deploy
      env:
        RAILS_MASTER_KEY:  ${{ secrets.RAILS_MASTER_KEY }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      run: kamal deploy --verbose
